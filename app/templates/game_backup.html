<!DOCTYPE html>
<html>
<head>
    <title>Continuous Update Demo</title>
    <!-- Pull in jQuery from Google -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
    <div>
        <h2>A continuously updated list:</h2>
        <ul id="culist"></ul>
    </div>
    

    <script type="text/javascript">
        function requestUpdate() {  // 3
        console.log("DEBUG: requesting update");
    
            $.getJSON('/_refresh', function(result) {  // 4
                
                const timestamp = new Date().toISOString(); // Obtém o timestamp atual no formato ISO
                console.log("DEBUG: Received data:", result.data, "at", timestamp);// Verifique o valor real de result.data
                // Verificar se a resposta contém 'undefined'
                if (result.data === undefined) {
                    console.log("DEBUG: Received undefined, stopping updates.");
                    // Interrompe as atualizações (limpa o intervalo)
                    clearInterval(intervalID);
                    console.log("QUIZ END")
                    //window.location.href = '/quiz/end'; // Redireciona para a página de fim de quiz
                    
                    //alert("Quiz completed or invalid response.");
                } else {
                    const HTML = `<li>[${timestamp}] ${result.data}</li>`; // Adiciona o timestamp no HTML
                    $("#culist").append(HTML);
                }
            }).fail(function(jqXHR, textStatus, errorThrown) {
                // Verificar se o erro é um 404
                if (jqXHR.status === 404) {
                    console.log("DEBUG: 404 error on /_refresh, redirecting to quiz end page.");
                    //window.location.href = '/quiz/end'; // Redireciona para a página de fim de quiz
                } else {
                    console.log("DEBUG: Error on GET request:", textStatus, errorThrown);
                }
            });
        }

        

        // This fires just once when the site initially loads
        $(document).ready(function() {
            console.log("DEBUG: document ready");
            const quizId = '{{ quiz_id }}'; // Assuming quiz_id is passed to the template
            const username = '{{username}}';
            // Automatically mark the player as ready when the page loads
            // First AJAX request to join the quiz
            $.ajax({
                    url: `/quiz/${quizId}/${username}/mark_ready`,
                    type: 'POST',
                    contentType: 'application/json',
                    //data: JSON.stringify({ username: username }),
                    success: function(response) {
                        console.log(response.message);
                    },
                    error: function(xhr) {
                        console.error("Error marking player as ready:", xhr);
                    }
                });
 

            requestUpdate();
            // Ensure list is updated every 5s
            var intervalID = setInterval(requestUpdate, 5000); // 2

            
        });
    </script>
</body>
</html>